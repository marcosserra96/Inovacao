<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz EMR ‚Äî Ranking</title>
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo-dot"></div><div class="title">Ranking</div>
    </div>
    <a class="btn ghost" href="index.html">Novo jogo</a>
  </div>

  <main class="container narrow">
    <section class="card">
      <table class="table">
        <thead><tr><th>#</th><th>Nome</th><th>Pontos</th><th>Tempo</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </section>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // üîß MESMO firebaseConfig DO QUIZ
  const firebaseConfig = {
    apiKey: "AIzaSyC2l8LU3vYfQjTly8JSa658mfIlVk2Dw8E",
    authDomain: "inovacao-emr.firebaseapp.com",
    projectId: "inovacao-emr",
    storageBucket: "inovacao-emr.firebasestorage.app",
    messagingSenderId: "1075399271811",
    appId: "1:1075399271811:web:f532f25547125d6a8f42b6",
    measurementId: "G-8CTLMNCZJN"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const rows = document.getElementById('rows') || document.getElementById('ranking-list');

  async function loadRanking(){
    try{
      // Pega top 100 ordenado por score (desc) ‚Äî SEM √≠ndice composto
      const q = query(collection(db,"scores"), orderBy("score","desc"), limit(100));
      const snap = await getDocs(q);

      const data = [];
      snap.forEach(doc => data.push(doc.data()));

      // Desempate local por tempo (asc)
      data.sort((a,b)=>{
        if ((b.score ?? 0) !== (a.score ?? 0)) return (b.score ?? 0) - (a.score ?? 0);
        return (a.totalTime ?? Infinity) - (b.totalTime ?? Infinity);
      });

      if (!rows) return;
      rows.innerHTML = "";

      if (data.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" style="padding:14px;color:#5e7d8c;">Sem resultados ainda.</td>`;
        rows.appendChild(tr);
        console.warn("Ranking vazio: confira se a cole√ß√£o 'scores' tem documentos e se o firebaseConfig √© o mesmo do quiz.");
        return;
      }

      let pos = 1;
      data.forEach(d=>{
        let medal = pos;
        if (pos===1) medal="üèÜ"; else if (pos===2) medal="ü•à"; else if (pos===3) medal="ü•â";

        // suporta tabela (#, Nome, Pontos, Tempo) ou <ol>
        if (rows.tagName === "TBODY") {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="rank-medal">${medal}</td>
            <td>${d.name || "-"}</td>
            <td>${d.score ?? 0}</td>
            <td>${(d.totalTime ?? 0).toFixed ? d.totalTime.toFixed(1) : d.totalTime}</td>
          `;
          rows.appendChild(tr);
        } else {
          const li = document.createElement('li');
          li.textContent = `${medal} ${d.name || "-"} ‚Äî ${d.score ?? 0} pts ‚Ä¢ ${d.totalTime ?? 0}s`;
          rows.appendChild(li);
        }
        pos++;
      });

    }catch(e){
      console.error("Erro carregando ranking:", e.code, e.message);
      // Se aparecer um link "Create index" no console, voc√™ pode clicar e criar o √≠ndice composto
      // e depois voltar para a vers√£o com dois orderBy (score desc, totalTime asc) e onSnapshot.
    }
  }

  loadRanking();
</script>

</body>
</html>
