<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz EMR — Perguntas</title>
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo-dot"></div><div class="title">Quiz EMR</div>
    </div>
    <div class="badge" id="player-pill">Jogador</div>
  </div>

  <main class="container narrow">
    <div class="topbar">
      <div class="pill" id="q-count">Pergunta —</div>
      <div class="progress"><div class="bar" id="progress"></div></div>
      <div class="pill" id="q-time">⏱ 0.0s</div>
      <a class="btn ghost" href="leaderboard.html">Ranking</a>
    </div>

    <section class="card">
      <h2 class="q-title" id="q-title"></h2>
      <div class="options" id="q-options"></div>

      <div class="grid" style="grid-template-columns: 1fr auto; align-items:center; margin-top:12px;">
        <div class="feedback" id="q-feedback"></div>
        <div class="actions">
          <button class="btn primary" id="next-btn" disabled>Próxima</button>
        </div>
      </div>
    </section>

    <section class="card" id="final" style="display:none">
      <h2>Resultado</h2>
      <div class="grid two">
        <div><strong>Pontuação:</strong> <span id="total-score">0</span></div>
        <div><strong>Tempo total:</strong> <span id="total-time">0.0s</span></div>
      </div>
      <div style="margin-top:12px;">
        <button class="btn primary" id="send-btn">Enviar e ver Ranking</button>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { QUESTIONS, computeScore } from "./js/questions.js";

    /* COLE SEU firebaseConfig AQUI */
    const firebaseConfig = {
      apiKey: "AIzaSyC2l8LU3vYfQjTly8JSa658mfIlVk2Dw8E",
      authDomain: "inovacao-emr.firebaseapp.com",
      projectId: "inovacao-emr",
      storageBucket: "inovacao-emr.firebasestorage.app",
      messagingSenderId: "1075399271811",
      appId: "1:1075399271811:web:f532f25547125d6a8f42b6",
      measurementId: "G-8CTLMNCZJN"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Elements
    const qs=(s)=>document.querySelector(s), qsa=(s)=>document.querySelectorAll(s);
    const qCount=qs('#q-count'), qTitle=qs('#q-title'), qOptions=qs('#q-options'),
          qFeedback=qs('#q-feedback'), nextBtn=qs('#next-btn'),
          progress=qs('#progress'), qTime=qs('#q-time'),
          finalBox=qs('#final'), totalScoreEl=qs('#total-score'), totalTimeEl=qs('#total-time'),
          playerPill=qs('#player-pill');

    const params = new URLSearchParams(location.search);
    const player = { name: params.get('name')||'Participante', email: params.get('email')||'' };
    playerPill.textContent = player.name;

    // State
    let idx=0, totalScore=0, totalTime=0, questionStart=0, canAnswer=true, anim=null, sessionId=null;

    // Firestore: cria sessão
    (async ()=>{
      try{
        const r = await addDoc(collection(db,"sessions"),{ name:player.name, email:player.email, startedAt:serverTimestamp() });
        sessionId = r.id;
      }catch(e){ console.error(e); }
    })();

    function setProgress(){ progress.style.width = Math.round((idx/QUESTIONS.length)*100) + "%"; }

    function startQuestion(){
      setProgress();
      const q = QUESTIONS[idx];
      qCount.textContent = `Pergunta ${idx+1} de ${QUESTIONS.length}`;
      qTitle.textContent = q.title;
      qOptions.innerHTML = "";
      qFeedback.textContent = "";
      nextBtn.disabled = true; canAnswer = true;

      q.options.forEach((opt,i)=>{
        const btn = document.createElement('button');
        btn.className = "option";
        btn.innerHTML = `<div class="bullet">${i+1}</div><div>${opt}</div>`;
        btn.onclick = ()=>answer(i);
        qOptions.appendChild(btn);
      });

      questionStart = performance.now();
      if (anim) cancelAnimationFrame(anim);
      const tick = ()=>{
        const s = (performance.now()-questionStart)/1000;
        qTime.textContent = `⏱ ${s.toFixed(1)}s`;
        anim = requestAnimationFrame(tick);
      };
      anim = requestAnimationFrame(tick);
    }

    function answer(index){
      if(!canAnswer) return;
      canAnswer = false;
      cancelAnimationFrame(anim);

      const elapsed = (performance.now()-questionStart)/1000;
      totalTime += elapsed;

      const q = QUESTIONS[idx];
      const correct = index === q.answerIndex;
      const score = computeScore(correct, elapsed);
      totalScore += score;

      qFeedback.textContent = correct ? `✔️ Correto! +${score} pontos` : `❌ Errado. +0 pontos`;
      qsa('.option').forEach((b,i)=>{
        b.disabled = true;
        b.classList.remove('selected');
        if(i===q.answerIndex) b.classList.add('success');
        if(i===index && i!==q.answerIndex) b.classList.add('danger');
      });
      nextBtn.disabled = false;
    }

    nextBtn.addEventListener('click', ()=>{
      idx++;
      if(idx < QUESTIONS.length){
        startQuestion();
      } else {
        setProgress();
        qs('section.card').style.display = 'none';
        finalBox.style.display = 'block';
        totalScoreEl.textContent = totalScore;
        totalTimeEl.textContent = `${totalTime.toFixed(1)}s`;
      }
    });

    qs('#send-btn')?.addEventListener('click', async ()=>{
      try{
        await addDoc(collection(db,"scores"),{
          sessionId, name:player.name, email:player.email,
          score: totalScore, totalTime: Math.round(totalTime*100)/100, createdAt: serverTimestamp()
        });
        location.href = "leaderboard.html";
      }catch(e){ alert("Falha ao enviar. Tente novamente."); }
    });

    startQuestion();
  </script>
</body>
</html>
