<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz EMR — Perguntas</title>
  <link rel="stylesheet" href="assets/styles.css?v=dev"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    .loading-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #f4f4f4;
      font-family: "Segoe UI", sans-serif;
      font-size: 1.2rem;
      color: #555;
    }
    #debug-box {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: #0f0;
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 8px;
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="brand">
      <span class="logo-dot"></span><span class="title">Quiz EMR</span>
    </div>
  </header>

  <section class="card quiz-wrap" id="quiz-container" style="display:none;">
    <div class="topbar">
      <span id="q-count" class="pill">Pergunta 1</span>
      <div class="progress"><div id="progress" class="bar"></div></div>
      <span id="q-time" class="timer">⏱ 0.0s</span>
    </div>

    <h2 id="q-title" class="q-title">Carregando…</h2>
    <div id="q-options"></div>
  </section>

  <div class="loading-screen" id="loading">Carregando configurações…</div>
  <div id="debug-box"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2l8LU3vYfQjTly8JSa658mfIlVk2Dw8E",
      authDomain: "inovacao-emr.firebaseapp.com",
      projectId: "inovacao-emr",
      storageBucket: "inovacao-emr.firebasestorage.app",
      messagingSenderId: "1075399271811",
      appId: "1:1075399271811:web:f532f25547125d6a8f42b6",
      measurementId: "G-8CTLMNCZJN"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);

    const player = {
      name: params.get('name') || 'Participante',
      id: (params.get('id') || 'anon')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .toLowerCase()
        .replace(/\s+/g,'-')
        .trim()
    };

    let CONFIG = { timePerQuestion: 20, loadingMessage: 'Carregando configurações…', debugMode: false };
    let QUESTIONS = [];

    const debugBox = document.getElementById('debug-box');
    function logDebug(msg){
      if(!CONFIG.debugMode) return;
      debugBox.style.display = 'block';
      const time = new Date().toLocaleTimeString();
      debugBox.innerHTML += `[${time}] ${msg}<br/>`;
      debugBox.scrollTop = debugBox.scrollHeight;
      console.log('[QUIZ DEBUG]', msg);
    }

    async function loadConfig() {
      try {
        logDebug('Conectando ao Firebase...');
        const qSnap = await getDoc(doc(db, 'config', 'questions'));
        const gSnap = await getDoc(doc(db, 'config', 'general'));
        const aSnap = await getDoc(doc(db, 'config', 'appearance'));
        logDebug('Documentos carregados.');

        if (gSnap.exists()) CONFIG = { ...CONFIG, ...gSnap.data() };
        if (qSnap.exists()) QUESTIONS = qSnap.data().list || [];
        if (aSnap.exists()) {
          const appData = aSnap.data();
          if (appData.quizTitle) $(".title").textContent = appData.quizTitle;
          if (appData.primaryColor) document.documentElement.style.setProperty('--primary', appData.primaryColor);
        }

        $('#loading').textContent = CONFIG.loadingMessage || 'Carregando configurações…';
        logDebug(`Mensagem de carregamento: ${CONFIG.loadingMessage}`);

      } catch (e) {
        logDebug('Erro ao carregar configurações: ' + e.message);
      }
      startQuiz();
    }

    loadConfig();

    const SESSION_KEY = `quiz-emr:${player.id}`;
    function loadState(){ try{return JSON.parse(localStorage.getItem(SESSION_KEY))||{}}catch{return {}} }
    function saveState(p){ localStorage.setItem(SESSION_KEY, JSON.stringify({ ...loadState(), ...p })); }
    function clearState(){ localStorage.removeItem(SESSION_KEY); }

    let state = loadState();
    if (!state.startedAt){
      state = { startedAt: Date.now(), idx:0, totalScore:0, totalTime:0 };
      saveState(state);
    }

    const shuffle = a => a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]);

    function computeScore(correct, used){
      if (!correct) return 0;
      const bonus = Math.max(0, (CONFIG.timePerQuestion - used));
      return Math.round(1000 + bonus * 10);
    }

    function startQuiz(){
      logDebug('Iniciando quiz...');
      if (!QUESTIONS.length) {
        alert('Nenhuma pergunta encontrada.');
        logDebug('Falha: Nenhuma pergunta carregada.');
        location.href = 'index.html';
        return;
      }

      $('#loading').style.display = 'none';
      $('#quiz-container').style.display = 'block';

      let QS = state.QS;
      if (!QS) {
        QS = shuffle(QUESTIONS).map(q => {
          const options = shuffle(q.options.slice());
          const answerText = q.options[q.answerIndex];
          const newAnswerIndex = options.indexOf(answerText);
          return { ...q, options, answerIndex: newAnswerIndex };
        });
        saveState({ ...state, QS });
      }

      const QTIME = CONFIG.timePerQuestion || 20;
      let idx=state.idx, totalScore=state.totalScore, totalTime=state.totalTime;
      let startTs=0, tickId=null, remaining=QTIME;

      const elCount=$('#q-count'), elBar=$('#progress'), elTimer=$('#q-time'), elTitle=$('#q-title'), elOpts=$('#q-options');

      function setProgress(){
        elBar.style.width = `${Math.round((idx/QS.length)*100)}%`;
        elCount.textContent = `Pergunta ${idx+1} de ${QS.length}`;
      }

      function prepareNextQuestion(){
        logDebug(`Preparando pergunta ${idx+1}`);
        const overlay = document.createElement('div');
        overlay.className = 'prepare-overlay';
        overlay.innerHTML = `<div style="text-align:center;"><div>Prepare-se!</div><div id="countdown" class="countdown">3</div></div>`;
        document.body.appendChild(overlay);

        let count = 3;
        const countdownEl = overlay.querySelector('#countdown');
        const timer = setInterval(()=>{
          count--;
          if(count>0){ countdownEl.textContent = count; }
          else {
            clearInterval(timer);
            overlay.remove();
            render();
          }
        },1000);
      }

      function showFeedback(type){
        const bf = document.createElement('div');
        bf.className = `bullet-feedback ${type}`;
        bf.textContent = type === 'correct' ? '✔️ Correto!' : type === 'wrong' ? '❌ Errado!' : '⏳ Tempo esgotado!';
        document.querySelector('.quiz-wrap').appendChild(bf);
        logDebug(`Feedback: ${bf.textContent}`);
        setTimeout(()=>{ bf.remove(); next(); },2000);
      }

      function render(){
        setProgress();
        const q = QS[idx];
        elTitle.textContent = q.title;
        elOpts.innerHTML = '';
        q.options.forEach((text,i)=>{
          const b=document.createElement('button');
          b.className='option';
          b.innerHTML = `<div class="bullet">${i+1}</div><div>${text}</div>`;
          b.onclick = ()=> answer(i);
          elOpts.appendChild(b);
        });
        startTs = performance.now();
        const tick=()=>{
          const passed=(performance.now()-startTs)/1000;
          const left=Math.max(0,QTIME-passed);
          remaining=left;
          elTimer.textContent=`⏱ ${left.toFixed(1)}s`;
          if (left<=0){ timeExpired(); return; }
          tickId=requestAnimationFrame(tick);
        };
        tickId=requestAnimationFrame(tick);
      }

      function lockOptions(){ [...elOpts.querySelectorAll('.option')].forEach(b=>b.disabled=true); }

      function answer(i){
        lockOptions();
        const used=Math.min(QTIME,(performance.now()-startTs)/1000);
        const q=QS[idx];
        const correct=(i===q.answerIndex);
        const pts=computeScore(correct,used);
        totalScore+=pts; totalTime+=used;
        saveState({ idx, totalScore, totalTime });
        logDebug(`Pergunta ${idx+1}: ${correct?'Correta':'Errada'} (${used.toFixed(1)}s)`);
        showFeedback(correct?'correct':'wrong');
      }

      function timeExpired(){
        lockOptions();
        totalTime += QTIME;
        saveState({ idx, totalScore, totalTime });
        logDebug(`Tempo expirado na pergunta ${idx+1}`);
        showFeedback('timeout');
      }

      function next(){
        if (tickId) cancelAnimationFrame(tickId);
        idx++;
        saveState({ idx, totalScore, totalTime, startedAt: Date.now(), QS });
        if (idx<QS.length) { prepareNextQuestion(); return; }
        finalize();
      }

      async function finalize(){
        logDebug('Finalizando quiz, salvando pontuação...');
        const ref=doc(db,'scores',player.id);
        try{
          const newData={
            name:player.name,
            score:Math.round(totalScore),
            totalTime:Math.round(totalTime*10)/10,
            updatedAt:serverTimestamp()
          };
          await setDoc(ref,newData);
          confetti({ particleCount:180, spread:70, origin:{ y:0.65 } });
          clearState();
          logDebug('Pontuação salva com sucesso!');
          setTimeout(()=> location.href=`index.html?me=${encodeURIComponent(player.name)}`,1200);
        }catch(err){
          console.error(err);
          alert('Falha ao enviar sua pontuação.');
          logDebug('Erro ao salvar pontuação: '+err.message);
        }
      }

      prepareNextQuestion();
    }
  </script>
</body>
</html>
