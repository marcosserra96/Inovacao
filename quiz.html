<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz EMR ‚Äî Perguntas</title>
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
  <div class="bg-gradient"></div>

  <header class="topbar card">
    <div class="brand sm">
      <div class="logo-dot"></div>
      <span>Quiz EMR</span>
    </div>
    <div class="progress-wrap"><div id="progress" class="progress-bar"></div></div>
    <div id="player-pill" class="pill"></div>
    <a class="btn ghost" href="leaderboard.html">Ranking</a>
  </header>

  <main class="container narrow">
    <section id="quiz" class="card entrance">
      <div class="question-head">
        <div class="pill"><strong id="q-count">‚Äî</strong></div>
        <div class="timer-ring" aria-label="tempo decorrido">
          <svg viewBox="0 0 36 36" class="circular-chart">
            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
            <path id="circle" class="circle" stroke-dasharray="100, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
          </svg>
          <div class="timer-text"><span id="q-timer">0.0</span>s</div>
        </div>
      </div>

      <h2 id="q-title" class="q-title"></h2>
      <div id="q-options" class="options"></div>

      <div class="feedback-row">
        <div id="q-feedback" class="feedback"></div>
        <button id="next-btn" class="btn primary" disabled>Pr√≥xima</button>
      </div>
    </section>

    <section id="final" class="card" style="display:none">
      <h2>Resultado</h2>
      <div class="result-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin:8px 0;">
        <div class="result-item" style="background:rgba(255,255,255,.06);border:1px solid var(--stroke);border-radius:14px;padding:12px;">
          <span class="label" style="display:block;color:var(--muted);font-size:12px;margin-bottom:6px;">Pontua√ß√£o</span>
          <span id="total-score" class="value" style="font-size:24px;font-weight:800;">0</span>
        </div>
        <div class="result-item" style="background:rgba(255,255,255,.06);border:1px solid var(--stroke);border-radius:14px;padding:12px;">
          <span class="label" style="display:block;color:var(--muted);font-size:12px;margin-bottom:6px;">Tempo total</span>
          <span id="total-time" class="value" style="font-size:24px;font-weight:800;">0.0s</span>
        </div>
      </div>
      <button id="send-btn" class="btn accent">Enviar e ver Ranking</button>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { QUESTIONS, computeScore } from "./js/questions.js";

    /* üîß COLE SEU firebaseConfig AQUI (o mesmo que j√° funciona no seu site)
    const firebaseConfig = { ... };
    */
    // se j√° colou antes, mantenha o mesmo bloco:
    const firebaseConfig = window.firebaseConfig || firebaseConfig;

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const qs = (s)=>document.querySelector(s);
    const qsa= (s)=>document.querySelectorAll(s);
    const params = new URLSearchParams(window.location.search);
    const player = {
      name: params.get('name') || 'Participante',
      email: params.get('email') || 'desconhecido@empresa.com'
    };

    let idx=0, totalScore=0, totalTime=0, questionStart=0, canAnswer=true, timerHandle=null, sessionId=null;

    // UI binds
    const qCount=qs('#q-count'), qTitle=qs('#q-title'), qOptions=qs('#q-options');
    const qTimer=qs('#q-timer'), qFeedback=qs('#q-feedback'), nextBtn=qs('#next-btn');
    const quizBox=qs('#quiz'), finalBox=qs('#final'), totalScoreEl=qs('#total-score'), totalTimeEl=qs('#total-time');
    const progress=qs('#progress'), circle=qs('#circle'), playerPill=qs('#player-pill');

    playerPill.textContent = player.name.length > 24 ? player.name.slice(0,24)+"‚Ä¶" : player.name;

    // cria sess√£o com timestamp do servidor
    (async ()=>{
      try{
        const ref = await addDoc(collection(db,"sessions"),{
          name:player.name, email:player.email, startedAt:serverTimestamp()
        });
        sessionId = ref.id;
      }catch(e){ console.error("Falha ao criar sess√£o:", e); }
    })();

    function setProgress(){
      const pct = Math.round((idx)/QUESTIONS.length*100);
      progress.style.width = pct+"%";
    }
    function updateTimerRing(pct){
      const dash = Math.max(0, Math.min(100, pct));
      circle.setAttribute('stroke-dasharray', dash + ", 100");
    }

    function startQuestion(){
      setProgress();
      const q = QUESTIONS[idx];
      qCount.textContent = `Pergunta ${idx+1} de ${QUESTIONS.length}`;
      qTitle.textContent = q.title;
      qOptions.innerHTML = "";
      qFeedback.textContent = "";
      nextBtn.disabled = true; canAnswer = true;

      q.options.forEach((opt,i)=>{
        const btn = document.createElement('button');
        btn.className = "btn option";
        btn.innerHTML = `<span class='bullet'>${i+1}</span> <span>${opt}</span>`;
        btn.onclick = ()=>answer(i);
        qOptions.appendChild(btn);
      });

      questionStart = performance.now();
      if (timerHandle) cancelAnimationFrame(timerHandle);
      const DURATION = 20000; // 20s visuais (ajuste se quiser)
      const tick = ()=>{
        const elapsed = performance.now() - questionStart;
        const elapsedSec = elapsed/1000;
        qTimer.textContent = elapsedSec.toFixed(1);
        const pct = Math.max(0, 100 - (elapsed/DURATION)*100); // 100‚Üí0
        updateTimerRing(pct);
        timerHandle = requestAnimationFrame(tick);
      };
      timerHandle = requestAnimationFrame(tick);
    }

    function answer(index){
      if(!canAnswer) return;
      canAnswer = false;
      cancelAnimationFrame(timerHandle);
      const elapsed = (performance.now() - questionStart)/1000;
      totalTime += elapsed;

      const q = QUESTIONS[idx];
      const correct = index === q.answerIndex;
      const score = computeScore(correct, elapsed);
      totalScore += score;

      qFeedback.textContent = correct ? `‚úîÔ∏è Correto! +${score} pontos` : `‚ùå Errado. +0 pontos`;
      qsa('.option').forEach((b,i)=>{
        b.disabled = true;
        b.classList.remove('selected');
        if(i===q.answerIndex) b.classList.add('success');
        if(i===index && i!==q.answerIndex) b.classList.add('danger');
      });
      nextBtn.disabled = false;
    }

    qOptions.addEventListener('click',(e)=>{
      const btn = e.target.closest('.option');
      if(!btn) return;
      qsa('.option').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
    });

    nextBtn.addEventListener('click',()=>{
      idx++;
      if(idx<QUESTIONS.length){
        startQuestion();
      }else{
        setProgress();
        quizBox.style.display = "none";
        totalScoreEl.textContent = totalScore;
        totalTimeEl.textContent = `${totalTime.toFixed(1)}s`;
        finalBox.style.display = "block";
      }
    });

    qs('#send-btn').addEventListener('click', async ()=>{
      try{
        await addDoc(collection(db,"scores"),{
          sessionId, name:player.name, email:player.email,
          score:totalScore, totalTime:Math.round(totalTime*100)/100,
          createdAt:serverTimestamp()
        });
        window.location.href = "leaderboard.html";
      }catch(e){
        alert("Falha ao enviar resultado. Verifique sua conex√£o e tente novamente.");
        console.error(e);
      }
    });

    // start
    startQuestion();
  </script>
</body>
</html>
