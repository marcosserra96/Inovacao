<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz EMR ‚Äî Perguntas</title>
  <link rel="stylesheet" href="assets/styles.css?v=dev"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body>
  <header class="header">
    <div class="brand">
      <span class="logo-dot"></span><span class="title">Quiz EMR</span>
    </div>
  </header>

  <section class="card quiz-wrap">
    <div class="topbar">
      <span id="q-count" class="pill">Pergunta 1</span>
      <div class="progress"><div id="progress" class="bar"></div></div>
      <span id="q-time" class="timer">‚è± 0.0s</span>
    </div>

    <h2 id="q-title" class="q-title">Carregando‚Ä¶</h2>
    <div id="q-options"></div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, doc, setDoc, serverTimestamp, getDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ======= CONFIGURA√á√ÉO FIREBASE =======
    const firebaseConfig = {
      apiKey: "AIzaSyC2l8LU3vYfQjTly8JSa658mfIlVk2Dw8E",
      authDomain: "inovacao-emr.firebaseapp.com",
      projectId: "inovacao-emr",
      storageBucket: "inovacao-emr.firebasestorage.app",
      messagingSenderId: "1075399271811",
      appId: "1:1075399271811:web:f532f25547125d6a8f42b6",
      measurementId: "G-8CTLMNCZJN"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ======= ELEMENTOS =======
    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const player = {
      name: params.get('name') || 'Participante',
      id: params.get('id') || (params.get('name') || 'anon').toLowerCase().replace(/\s+/g,'-')
    };

    const elCount=$('#q-count'),
          elBar=$('#progress'),
          elTimer=$('#q-time'),
          elTitle=$('#q-title'),
          elOpts=$('#q-options');

    // ======= VARI√ÅVEIS GLOBAIS =======
    let QTIME = 20;        // valor padr√£o (ser√° sobrescrito)
    let BASE_SCORE = 1000; // valor padr√£o (ser√° sobrescrito)
    let QS = [];
    let idx = 0, totalScore = 0, totalTime = 0, startTs = 0, tickId = null;

    // ======= FUN√á√ïES FIREBASE =======

    // üîπ Busca configura√ß√µes do quiz
    async function loadConfig() {
      try {
        const ref = doc(db, "config", "quizSettings");
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const cfg = snap.data();
          QTIME = cfg.tempoPorPergunta ?? 20;
          BASE_SCORE = cfg.pontosPorAcerto ?? 1000;
        }
      } catch (err) {
        console.warn("Erro ao carregar configura√ß√µes:", err);
      }
    }

    // üîπ Busca perguntas no Firestore
    async function loadQuestions(){
      const snap = await getDocs(collection(db, "questions"));
      return snap.docs.map(d => d.data());
    }

    // ======= L√ìGICA DO QUIZ =======
    const shuffle = a => a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]);
    const computeScore = (correct, time)=> correct ? Math.round(BASE_SCORE*(1 - (time/QTIME)*0.5)) : 0;

    async function startQuiz(){
      elTitle.textContent = "Carregando perguntas‚Ä¶";
      await loadConfig();                     // l√™ tempo e pontua√ß√£o do painel
      const questions = await loadQuestions();// l√™ perguntas do Firebase
      if (!questions.length) {
        elTitle.textContent = "Nenhuma pergunta cadastrada.";
        return;
      }
      QS = shuffle(questions);
      render();
    }

    function setProgress(){
      elBar.style.width = `${Math.round((idx/QS.length)*100)}%`;
      elCount.textContent = `Pergunta ${idx+1} de ${QS.length}`;
    }

    function render(){
      setProgress();
      const q = QS[idx];
      elTitle.textContent = q.title;
      elOpts.innerHTML = "";
      q.options.forEach((text,i)=>{
        const b=document.createElement('button');
        b.className='option';
        b.innerHTML = `<div class="bullet">${i+1}</div><div>${text}</div>`;
        b.onclick = ()=> answer(i);
        elOpts.appendChild(b);
      });
      startTs = performance.now();
      tick();
    }

    function tick(){
      const passed=(performance.now()-startTs)/1000;
      const left=Math.max(0,QTIME-passed);
      elTimer.textContent=`‚è± ${left.toFixed(1)}s`;
      if(left<=0){ timeExpired(); return; }
      tickId=requestAnimationFrame(tick);
    }

    function lockOptions(){ [...elOpts.querySelectorAll('.option')].forEach(b=>b.disabled=true); }

    function answer(i){
      lockOptions();
      const used=(performance.now()-startTs)/1000;
      const q=QS[idx];
      const correct=(i===q.answerIndex);
      const pts=computeScore(correct,used);
      totalScore+=pts; totalTime+=used;
      showFeedback(correct?"correct":"wrong");
    }

    function timeExpired(){
      lockOptions();
      totalTime += QTIME;
      showFeedback("timeout");
    }

    function showFeedback(type){
      const bf=document.createElement('div');
      bf.className=`bullet-feedback ${type}`;
      bf.textContent = type==="correct"?"‚úîÔ∏è Correto!":type==="wrong"?"‚ùå Errado!":"‚è≥ Tempo esgotado!";
      document.body.appendChild(bf);
      setTimeout(()=>{ bf.remove(); next(); },2000);
    }

    async function next(){
      if (tickId) cancelAnimationFrame(tickId);
      idx++;
      if(idx<QS.length){ render(); return; }
      await finalize();
    }

    async function finalize(){
      const ref=doc(db,"scores",player.id);
      await setDoc(ref,{
        name:player.name,
        score:Math.round(totalScore),
        totalTime:Math.round(totalTime*10)/10,
        updatedAt:serverTimestamp()
      });
      confetti({ particleCount:180, spread:70, origin:{ y:0.65 } });
      setTimeout(()=> location.href=`index.html?me=${encodeURIComponent(player.name)}`,1500);
    }

    // ======= INICIAR QUIZ =======
    startQuiz();
  </script>
</body>
</html>
