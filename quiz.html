<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz EMR — Perguntas</title>
  <link rel="stylesheet" href="assets/styles.css?v=dev"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body>
  <header class="header">
    <div class="brand">
      <span class="logo-dot"></span><span class="title">Quiz EMR</span>
    </div>
  </header>

  <section class="card quiz-wrap">
    <div class="topbar">
      <span id="q-count" class="pill">Pergunta 1</span>
      <div class="progress"><div id="progress" class="bar"></div></div>
      <span id="q-time" class="timer">⏱ 0.0s</span>
    </div>
    <h2 id="q-title" class="q-title">Carregando…</h2>
    <div id="q-options"></div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { QUESTIONS, computeScore } from "./js/questions.js?v=dev";

    const firebaseConfig = {
      apiKey: "AIzaSyC2l8LU3vYfQjTly8JSa658mfIlVk2Dw8E",
      authDomain: "inovacao-emr.firebaseapp.com",
      projectId: "inovacao-emr",
      storageBucket: "inovacao-emr.firebasestorage.app",
      messagingSenderId: "1075399271811",
      appId: "1:1075399271811:web:f532f25547125d6a8f42b6"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const params = new URLSearchParams(location.search);
    const player = { 
      name: params.get('name'), 
      id: params.get('id'), 
      fase: parseInt(params.get('fase')||'1') 
    };
    const docId = player.id;

    const ref = doc(db,"scores",docId);
    const snap = await getDoc(ref);
    if (snap.exists() && snap.data().fases && snap.data().fases[player.fase]) {
      alert(`Você já respondeu a fase ${player.fase}. Aguarde a próxima!`);
      location.href="index.html";
    }

    // ===== Perguntas da fase =====
    const shuffle = a => a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]);
    let QS = shuffle(QUESTIONS.filter(q=>q.fase===player.fase));

    let idx=0,totalScore=0,totalTime=0;
    const QTIME=20;
    let tickId;

    const $=s=>document.querySelector(s);
    const elCount=$('#q-count'), elBar=$('#progress'), elTimer=$('#q-time'), elTitle=$('#q-title'), elOpts=$('#q-options');

    function setProgress(){
      elBar.style.width = `${Math.round((idx/QS.length)*100)}%`;
      elCount.textContent = `Pergunta ${idx+1} de ${QS.length}`;
    }

    function render(){
      setProgress();
      const q=QS[idx];
      elTitle.textContent=q.title;
      elOpts.innerHTML="";
      q.options.forEach((t,i)=>{
        const b=document.createElement("button");
        b.className="option";
        b.textContent=t;
        b.onclick=()=>answer(i);
        elOpts.appendChild(b);
      });
      const start=performance.now();
      const tick=()=>{
        const pass=(performance.now()-start)/1000;
        const left=Math.max(0,QTIME-pass);
        elTimer.textContent=`⏱ ${left.toFixed(1)}s`;
        if(left<=0){ timeExpired(); return; }
        tickId=requestAnimationFrame(tick);
      };
      tickId=requestAnimationFrame(tick);
    }

    function answer(i){
      if(tickId) cancelAnimationFrame(tickId);
      const q=QS[idx];
      const correct=(i===q.answerIndex);
      const pts=computeScore?computeScore(correct,5):(correct?1000:0);
      if(correct) totalScore+=pts;
      idx++;
      if(idx<QS.length) render(); else finalize();
    }

    function timeExpired(){
      idx++;
      if(idx<QS.length) render(); else finalize();
    }

    async function finalize(){
      const snap = await getDoc(ref);
      let oldScore=0, oldTime=0, fases={};
      if(snap.exists()){
        const d=snap.data();
        oldScore=d.score||0;
        oldTime=d.totalTime||0;
        fases=d.fases||{};
      }
      fases[player.fase]={ score: totalScore, time: totalTime };
      const newData={
        name:player.name,
        score: oldScore+totalScore,
        totalTime: oldTime+totalTime,
        updatedAt: serverTimestamp(),
        fases
      };
      await setDoc(ref,newData);
      confetti();
      setTimeout(()=>location.href="index.html",1500);
    }

    render();
  </script>
</body>
</html>
