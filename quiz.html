<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz EMR — Jogo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css?v=3">
  <!-- marked (markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header class="topbar small">
    <div class="container topbar-inner">
      <div class="brand">
        <div class="brand-logo" aria-hidden><svg width="28" height="28" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="var(--logo-dot)"/></svg></div>
        <div class="brand-text"><div class="title">Quiz EMR</div><div class="subtitle">Boa sorte!</div></div>
      </div>
      <div class="actions"><div id="player" class="muted">Carregando...</div></div>
    </div>
  </header>

  <main class="container">
    <section class="card quiz-card">
      <div id="question-wrap">
        <h2 id="q-title" class="q-title">Pergunta</h2>
        <div id="q-body" class="q-body muted">(carregando...)</div>
        <div id="options" class="options"></div>
        <div class="quiz-controls">
          <button id="prev" class="btn">Anterior</button>
          <button id="submit" class="btn primary">Confirmar / Próximo</button>
        </div>
      </div>

      <aside class="summary">
        <div class="stat"><div class="stat-num" id="stat-q">0</div><div class="stat-label">Pergunta</div></div>
        <div class="stat"><div class="stat-num" id="stat-score">0</div><div class="stat-label">Pontos</div></div>
        <div class="stat"><div class="stat-num" id="stat-time">0.0s</div><div class="stat-label">Tempo</div></div>
      </aside>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2l8LU3vYfQjTly8JSa658mfIlVk2Dw8E",
      authDomain: "inovacao-emr.firebaseapp.com",
      projectId: "inovacao-emr",
      storageBucket: "inovacao-emr.firebasestorage.app",
      messagingSenderId: "1075399271811",
      appId: "1:1075399271811:web:f532f255d6a8f42b6",
      measurementId: "G-8CTLMNCZJN"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // url params
    const params = new URLSearchParams(location.search);
    const playerId = params.get('id') || ('guest-'+Date.now());
    const playerName = params.get('name') || 'Convidado';
    document.getElementById('player').textContent = playerName;

    // load questions
    let questions = [];
    async function loadQuestions(){
      try{
        const r = await fetch('data/questions.json?v=1');
        const j = await r.json();
        if(Array.isArray(j.questions)) questions = j.questions;
      }catch(e){ console.warn(e); questions=[]; }
    }
    await loadQuestions();

    // state
    let idx=0, score=0, startTime=null, questionStart=null;
    const qTitle = document.getElementById('q-title');
    const qBody = document.getElementById('q-body');
    const optionsEl = document.getElementById('options');
    const statQ = document.getElementById('stat-q');
    const statScore = document.getElementById('stat-score');
    const statTime = document.getElementById('stat-time');

    function renderMarkdown(md){
      // marked is safe if we sanitize — we will escape by default and allow basic tags
      const html = marked.parse(md || '');
      return html;
    }

    function renderQuestion(i){
      const q = questions[i];
      if(!q){ qTitle.textContent = 'Fim'; qBody.innerHTML = '<p>Não há mais perguntas.</p>'; optionsEl.innerHTML=''; return; }
      qTitle.textContent = `Q${i+1}. ${q.title || ''}`;
      qBody.innerHTML = renderMarkdown(q.body || '');
      optionsEl.innerHTML = '';
      if(Array.isArray(q.choices) && q.choices.length){
        q.choices.forEach((c,ci)=>{
          const btn = document.createElement('button');
          btn.className = 'opt';
          btn.type = 'button';
          btn.innerHTML = (typeof c === 'string') ? renderMarkdown(c) : renderMarkdown(c.text || '');
          btn.onclick = ()=> selectOption(ci);
          optionsEl.appendChild(btn);
        });
      } else {
        const ta = document.createElement('textarea'); ta.className='free'; ta.placeholder='Digite sua resposta...';
        optionsEl.appendChild(ta);
      }
      statQ.textContent = `${i+1}/${questions.length}`;
      questionStart = performance.now();
      if(!startTime) startTime = Date.now();
    }

    function selectOption(ci){
      [...optionsEl.children].forEach((el,ii)=> el.classList.toggle('sel', ii===ci));
      optionsEl.dataset.selected = ci;
    }

    function updateStats(){
      statScore.textContent = score;
      const elapsed = (Date.now() - startTime)/1000;
      statTime.textContent = `${elapsed.toFixed(1)}s`;
    }

    document.getElementById('prev').onclick = ()=> { if(idx>0){ idx--; renderQuestion(idx); updateStats(); } };

    document.getElementById('submit').onclick = async ()=>{
      const q = questions[idx];
      if(!q) return;
      const timeSpent = (performance.now() - questionStart)/1000;
      let correct = false;
      if(Array.isArray(q.choices) && q.choices.length){
        const sel = parseInt(optionsEl.dataset.selected);
        if(!Number.isFinite(sel)) { alert('Escolha uma opção.'); return; }
        const choice = q.choices[sel];
        if(choice && ((typeof choice === 'object' && choice.correct) || choice === true || choice === 'true')) correct = !!(choice.correct || (choice === true));
      } else if(q.answer){
        const val = (optionsEl.querySelector('textarea')?.value || '').trim().toLowerCase();
        if(val && q.answer.trim().toLowerCase() === val) correct = true;
      }
      if(correct) score += (q.points ?? 1);
      idx++;
      updateStats();
      if(idx >= questions.length){
        const totalTime = (Date.now() - startTime)/1000;
        try{
          await addDoc(collection(db,'scores'), { name: playerName, id: playerId, score, totalTime, createdAt: serverTimestamp() });
          alert(`Fim! Pontuação: ${score} • Tempo: ${totalTime.toFixed(1)}s`);
        }catch(e){ console.error('save failed',e); alert(`Fim! (não foi possível salvar: veja console). Pontos: ${score}`); }
        renderQuestion(idx);
      } else {
        renderQuestion(idx);
      }
    };

    renderQuestion(0);
    updateStats();
  </script>
</body>
</html>
