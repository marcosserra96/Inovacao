<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz EMR — Perguntas</title>
  <link rel="stylesheet" href="assets/styles.css?v=dev"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body>
  <header class="header">
    <div class="brand">
      <span class="logo-dot"></span><span class="title">Quiz EMR</span>
    </div>
  </header>

  <section class="card quiz-wrap">
    <div class="topbar">
      <span id="q-count" class="pill">Pergunta 1</span>
      <div class="progress"><div id="progress" class="bar"></div></div>
      <span id="q-time" class="timer">⏱ 0.0s</span>
    </div>

    <h2 id="q-title" class="q-title">Carregando…</h2>
    <div id="q-options"></div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { QUESTIONS, computeScore } from "./js/questions.js?v=dev";

    const firebaseConfig = {
      apiKey: "AIzaSyC2l8LU3vYfQjTly8JSa658mfIlVk2Dw8E",
      authDomain: "inovacao-emr.firebaseapp.com",
      projectId: "inovacao-emr",
      storageBucket: "inovacao-emr.firebasestorage.app",
      messagingSenderId: "1075399271811",
      appId: "1:1075399271811:web:f532f25547125d6a8f42b6",
      measurementId: "G-8CTLMNCZJN"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const player = {
      name:  params.get('name')  || 'Participante',
      email: (params.get('email')|| '').trim()
    };

    const SESSION_KEY = `quiz-emr:${player.email||'anon'}`;
    function loadState(){ try{return JSON.parse(localStorage.getItem(SESSION_KEY))||{}}catch{return {}} }
    function saveState(p){ localStorage.setItem(SESSION_KEY, JSON.stringify({ ...loadState(), ...p })); }
    function clearState(){ localStorage.removeItem(SESSION_KEY); }

    let state = loadState();
    if (!state.idx && state.idx !== 0){
      state = { idx:0, totalScore:0, totalTime:0 };
      saveState(state);
    }

    const shuffle = a => a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]);
    let QS = shuffle(QUESTIONS).map(q => ({ ...q, options: shuffle(q.options.slice()) }));

    const QTIME = 20;
    let idx=state.idx, totalScore=state.totalScore, totalTime=state.totalTime;
    let startTs=0, tickId=null, remaining=QTIME;

    const elCount=$('#q-count'), elBar=$('#progress'), elTimer=$('#q-time'), elTitle=$('#q-title'), elOpts=$('#q-options');

    function setProgress(){
      elBar.style.width = `${Math.round((idx/QS.length)*100)}%`;
      elCount.textContent = `Pergunta ${idx+1} de ${QS.length}`;
    }

    // ===== Overlay Prepare-se =====
    function prepareNextQuestion(){
      const overlay = document.createElement('div');
      overlay.className = 'prepare-overlay';
      overlay.innerHTML = `
        <div style="text-align:center;">
          <div>Prepare-se!</div>
          <div id="countdown" class="countdown">3</div>
        </div>`;
      document.body.appendChild(overlay);

      let count = 3;
      const countdownEl = overlay.querySelector('#countdown');
      const timer = setInterval(()=>{
        count--;
        if(count>0){
          countdownEl.textContent = count;
          countdownEl.classList.remove('pop');
          void countdownEl.offsetWidth;
          countdownEl.classList.add('pop');
        } else {
          clearInterval(timer);
          overlay.remove();
          render();
        }
      },1000);
    }

    // ===== Feedback estilo Face ID =====
    function showFeedback(type){
      const card = document.createElement('div');
      card.className = `feedback-card ${type}`;
      let msg = "";
      if(type==="correct") msg = "✔️ Correto!";
      if(type==="wrong")   msg = "❌ Errado!";
      if(type==="timeout") msg = "⏳ Tempo esgotado!";
      card.textContent = msg;

      const container = document.querySelector('.quiz-wrap') || document.body;
      container.appendChild(card);

      setTimeout(()=>{
        card.style.animation = "card-fade-out 0.4s ease-in forwards";
        setTimeout(()=>{
          card.remove();
          next();
        }, 400);
      }, 2000);
    }

    function render(){
      setProgress();
      const q = QS[idx];
      elTitle.textContent = q.title;
      elOpts.innerHTML = "";

      q.options.forEach((text,i)=>{
        const b=document.createElement('button');
        b.className='option';
        b.innerHTML = `<div class="bullet">${i+1}</div><div>${text}</div>`;
        b.onclick = ()=> answer(i);
        elOpts.appendChild(b);
      });

      // Reseta timer ao começar a pergunta
      startTs = performance.now();
      state.startedAt = Date.now();
      saveState(state);

      if (tickId) cancelAnimationFrame(tickId);
      const tick=()=>{
        const passed=(performance.now()-startTs)/1000;
        const left=Math.max(0,QTIME-passed);
        remaining=left;
        elTimer.textContent=`⏱ ${left.toFixed(1)}s`;
        if (left<=0){ timeExpired(); return; }
        tickId=requestAnimationFrame(tick);
      };
      tickId=requestAnimationFrame(tick);
    }

    function lockOptions(){ [...elOpts.querySelectorAll('.option')].forEach(b=>b.disabled=true); }

    function answer(i){
      lockOptions();
      const used=Math.min(QTIME,(performance.now()-startTs)/1000);
      const q=QS[idx];
      const correct=(i===q.answerIndex);
      const pts=computeScore?computeScore(correct,used):(correct?1000:0);
      totalScore+=pts; totalTime+=used;

      [...elOpts.children].forEach((btn,ii)=>{
        if (ii===q.answerIndex) btn.classList.add('success');
        if (ii===i && ii!==q.answerIndex) btn.classList.add('danger');
      });

      saveState({ idx, totalScore, totalTime });
      if(correct) showFeedback("correct");
      else showFeedback("wrong");
    }

    function timeExpired(){
      lockOptions();
      totalTime += QTIME;
      saveState({ idx, totalScore, totalTime });
      showFeedback("timeout");
    }

    function next(){
      if (tickId) cancelAnimationFrame(tickId);
      idx++;
      saveState({ idx, totalScore, totalTime });
      if (idx<QS.length) { prepareNextQuestion(); return; }
      finalize();
    }

    async function finalize(){
      const emailId=(player.email||'anon').toLowerCase();
      const ref=doc(db,"scores",emailId);
      try{
        const newData={
          name:player.name,
          email:player.email,
          score:Math.round(totalScore),
          totalTime:Math.round(totalTime*10)/10,
          updatedAt:serverTimestamp()
        };
        await setDoc(ref,newData);
        confetti({ particleCount:180, spread:70, origin:{ y:0.65 } });
        clearState();
        const me=encodeURIComponent(player.email||'');
        setTimeout(()=> location.href=`index.html?me=${me}`,1200);
      }catch(err){ console.error(err); alert("Falha ao enviar sua pontuação."); }
    }

    window.addEventListener('beforeunload',e=>{
      if (idx<QS.length){ e.preventDefault(); e.returnValue=''; }
    });

    prepareNextQuestion();
  </script>
</body>
</html>
