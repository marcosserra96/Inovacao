<!DOCTYPE html>
<html lang="pt-BR">
>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz EMR</title>
  <link rel="stylesheet" href="assets/styles.css?v=dev"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      getDoc,
      doc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // 🔥 Firebase Configuração
    const firebaseConfig = {
      apiKey: "AIzaSyC2l8LU3vYfQjTly8JSa658mfIlVk2Dw8E",
      authDomain: "inovacao-emr.firebaseapp.com",
      projectId: "inovacao-emr",
      storageBucket: "inovacao-emr.appspot.com",
      messagingSenderId: "1075399271811",
      appId: "1:1075399271811:web:f532f25547125d6a8f42b6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 🔹 Variáveis globais
    let questions = [];
    let currentQuestion = 0;
    let score = 0;
    let timer;
    let timeLeft;
    let tempoPorPergunta = 20;
    let pontosPorAcerto = 1000;
    let totalTime = 0;

    // 🔹 Recupera dados da URL
    const params = new URLSearchParams(window.location.search);
    const playerId = params.get("id");
    const playerName = params.get("name") || "Jogador";

    const questionEl = document.querySelector(".question");
    const optionsEl = document.querySelector(".options");
    const timerBarEl = document.querySelector(".timer-bar");
    const overlayEl = document.querySelector(".overlay");
    const feedbackEl = document.querySelector(".feedback");
    const progressEl = document.querySelector(".progress");

    // =============================
    // 📥 Carrega perguntas e configs
    // =============================
    async function loadData() {
      // Configurações
      const cfgSnap = await getDoc(doc(db, "config", "quizSettings"));
      if (cfgSnap.exists()) {
        const cfg = cfgSnap.data();
        tempoPorPergunta = cfg.tempoPorPergunta ?? 20;
        pontosPorAcerto = cfg.pontosPorAcerto ?? 1000;
      }

      // Perguntas
      const snap = await getDocs(collection(db, "questions"));
      questions = snap.docs.map(doc => doc.data());

      // Embaralhar perguntas
      questions.sort(() => Math.random() - 0.5);
      startQuiz();
    }

    // =============================
    // ▶️ Inicia o Quiz
    // =============================
    function startQuiz() {
      currentQuestion = 0;
      score = 0;
      totalTime = 0;
      showQuestion();
    }

    // =============================
    // 💬 Exibe pergunta
    // =============================
    function showQuestion() {
      if (currentQuestion >= questions.length) {
        endQuiz();
        return;
      }

      const q = questions[currentQuestion];
      questionEl.textContent = q.title;
      optionsEl.innerHTML = "";

      const shuffled = q.options
        .map((text, i) => ({ text, i }))
        .sort(() => Math.random() - 0.5);

      shuffled.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt.text;
        btn.className = "option";
        btn.onclick = () => selectAnswer(opt.i === q.answerIndex);
        optionsEl.appendChild(btn);
      });

      progressEl.textContent = `Pergunta ${currentQuestion + 1} de ${questions.length}`;
      startTimer();
    }

    // =============================
    // ⏱️ Timer
    // =============================
    function startTimer() {
      clearInterval(timer);
      timeLeft = tempoPorPergunta;
      timerBarEl.style.width = "100%";

      timer = setInterval(() => {
        timeLeft--;
        totalTime++;

        timerBarEl.style.width = `${(timeLeft / tempoPorPergunta) * 100}%`;
        if (timeLeft <= 0) {
          clearInterval(timer);
          selectAnswer(false, true);
        }
      }, 1000);
    }

    // =============================
    // 🧠 Seleciona resposta
    // =============================
    function selectAnswer(correct, timeout = false) {
      clearInterval(timer);

      if (correct) {
        score += pontosPorAcerto;
        feedbackEl.textContent = "✔️ Correto!";
        feedbackEl.className = "feedback correct";
        launchConfetti();
      } else if (timeout) {
        feedbackEl.textContent = "⏳ Tempo esgotado!";
        feedbackEl.className = "feedback timeout";
      } else {
        feedbackEl.textContent = "❌ Errado!";
        feedbackEl.className = "feedback wrong";
      }

      overlayEl.style.display = "flex";
      setTimeout(() => {
        overlayEl.style.display = "none";
        feedbackEl.textContent = "";
        currentQuestion++;
        showQuestion();
      }, 1500);
    }

    // =============================
    // 🎉 Confete
    // =============================
    function launchConfetti() {
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 },
      });
    }

    // =============================
    // 🏁 Fim do Quiz
    // =============================
    async function endQuiz() {
      overlayEl.style.display = "flex";
      feedbackEl.textContent = "🏆 Parabéns! Quiz concluído!";

      await setDoc(doc(db, "scores", playerId), {
        id: playerId,
        name: playerName,
        score: score,
        time: (totalTime).toFixed(1),
        timestamp: new Date()
      });

      setTimeout(() => {
        window.location.href = "index.html";
      }, 3000);
    }

    // 🚀 Inicia tudo
    loadData();
  </script>
</head>

<body>
  <div class="quiz">
    <div class="progress"></div>
    <div class="question">Carregando perguntas...</div>
    <div class="options"></div>
    <div class="timer">
      <div class="timer-bar"></div>
    </div>
  </div>

  <div class="overlay">
    <div class="feedback"></div>
  </div>
</body>
</html>
