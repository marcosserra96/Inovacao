<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz EMR â€” InÃ­cio</title>
  <link rel="stylesheet" href="assets/styles.css?v=dev"/>
</head>
<body>
  <header class="header">
    <div class="brand">
      <span class="logo-dot"></span><span class="title">Quiz EMR</span>
    </div>
  </header>

  <main class="grid-home card">
    <!-- Lado esquerdo: Hero + Form -->
    <section class="hero">
      <h1>Quiz EMR</h1>
      <p>Responda rÃ¡pido e acerte para marcar mais pontos. ðŸŽ¯</p>

      <form id="start-form" class="form">
        <label for="name">Seu nome</label>
        <input id="name" name="name" type="text" placeholder="Ex.: Ana Souza" required class="input"/>

        <label for="email">Seu e-mail</label>
        <input id="email" name="email" type="email" placeholder="nome@empresa.com" required class="input"/>

        <button type="submit" class="btn btn-primary btn-pill">ComeÃ§ar</button>
      </form>

      <p class="muted">Ao iniciar, vocÃª concorda em aparecer no ranking do evento.</p>
    </section>

    <!-- Lado direito: Ranking -->
    <aside class="side">
      <h2>Ranking</h2>
      <table class="table">
        <thead>
          <tr><th>#</th><th>Nome</th><th>Pontos</th><th>Tempo</th></tr>
        </thead>
        <tbody id="ranking-rows">
          <tr><td colspan="4"><div class="skel"></div></td></tr>
          <tr><td colspan="4"><div class="skel"></div></td></tr>
          <tr><td colspan="4"><div class="skel"></div></td></tr>
        </tbody>
      </table>
    </aside>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, getDocs, orderBy, limit, query } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2l8LU3vYfQjTly8JSa658mfIlVk2Dw8E",
      authDomain: "inovacao-emr.firebaseapp.com",
      projectId: "inovacao-emr",
      storageBucket: "inovacao-emr.firebasestorage.app",
      messagingSenderId: "1075399271811",
      appId: "1:1075399271811:web:f532f25547125d6a8f42b6",
      measurementId: "G-8CTLMNCZJN"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ----- FormulÃ¡rio de inÃ­cio -----
    const form = document.getElementById('start-form');
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      if(!name || !email) return;
      location.href = `quiz.html?name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`;
    });

    // ----- Ranking -----
    const params = new URLSearchParams(location.search);
    const me = params.get("me") || "";

    async function loadRanking(){
      const rows = document.getElementById('ranking-rows');
      rows.innerHTML = "";
      try{
        const q = query(collection(db,"scores"), orderBy("score","desc"), orderBy("totalTime","asc"), limit(10));
        const snap = await getDocs(q);

        let pos = 0;
        snap.forEach(docSnap=>{
          pos++;
          const data = docSnap.data();
          const tr = document.createElement("tr");
          if (data.email && me && data.email.toLowerCase()===me.toLowerCase()){
            tr.classList.add("me");
          }
          tr.innerHTML = `
            <td>${pos}</td>
            <td>${data.name||'-'}</td>
            <td>${data.score||0}</td>
            <td>${data.totalTime||0}s</td>`;
          rows.appendChild(tr);
        });

        if(rows.innerHTML===""){ 
          rows.innerHTML = `<tr><td colspan="4" class="muted">Nenhum resultado ainda.</td></tr>`;
        }
      }catch(err){
        console.error(err);
        rows.innerHTML = `<tr><td colspan="4" class="muted">Erro ao carregar ranking</td></tr>`;
      }
    }

    loadRanking();
  </script>
</body>
</html>
