<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz de Seguran√ßa - EMR</title>
  <link rel="stylesheet" href="assets/styles.css?v=dev"/>
</head>
<body>
  <header class="header" style="position:relative">
    <div class="brand" id="brand" style="position:relative">
      <span class="logo-dot"></span><span class="title">Quiz de Seguran√ßa - EMR</span>
    </div>
  </header>

  <section class="card">
    <div class="grid-home">
      <!-- HERO -->
      <div class="hero">
        <h1>Pronto para jogar? üéØ</h1>
        <p>Digite seu nome para come√ßar.</p>

        <form id="start-form" class="form" novalidate>
          <input id="name" class="input" type="text" placeholder="Digite seu nome" required autocomplete="off" />
          <button id="start-btn" class="btn btn-pill btn-primary" type="submit">Come√ßar agora</button>
          <p id="loadMsg" class="muted" role="status"></p>
        </form>
      </div>

      <!-- RANKING -->
      <aside class="side">
        <h2>üèÜ Ranking</h2>
        <table class="table">
          <thead><tr><th>#</th><th>Nome</th><th>Pontos</th><th>Tempo</th></tr></thead>
          <tbody id="ranking-rows">
            <tr><td colspan="4"><div class="skel"></div></td></tr>
            <tr><td colspan="4"><div class="skel"></div></td></tr>
            <tr><td colspan="4"><div class="skel"></div></td></tr>
          </tbody>
        </table>
        <p class="muted">Mostrando os 10 melhores (desempate por tempo).</p>
      </aside>
    </div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2l8LU3vYfQjTly8JSa658mfIlVk2Dw8E",
      authDomain: "inovacao-emr.firebaseapp.com",
      projectId: "inovacao-emr",
      storageBucket: "inovacao-emr.firebasestorage.app",
      messagingSenderId: "1075399271811",
      appId: "1:1075399271811:web:f532f25547125d6a8f42b6",
      measurementId: "G-8CTLMNCZJN"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    function makeDocId(name){
      return (name||'anon')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .toLowerCase()
        .replace(/\s+/g,'-')
        .trim();
    }

    const nameEl = document.getElementById('name');
    const startBtn = document.getElementById('start-btn');
    const loadMsg  = document.getElementById('loadMsg');
    const rows = document.getElementById('ranking-rows');

    // ‚úÖ Habilita o bot√£o e ajusta mensagem
    startBtn.disabled = false;
    loadMsg.textContent = "Digite seu nome para come√ßar.";

    // ====== FORM SUBMIT ======
    document.getElementById('start-form').addEventListener('submit', async (e)=>{
      e.preventDefault();

      const playerName = nameEl.value.trim();
      if(!playerName){
        alert("Informe seu nome para come√ßar.");
        return;
      }

      try {
        const docId = makeDocId(playerName);
        const ref = doc(db,"scores",docId);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          alert("Voc√™ j√° participou do quiz e n√£o pode jogar novamente.");
          return;
        }

        const qs = new URLSearchParams({ id: docId, name: playerName }).toString();
        location.href = `quiz.html?${qs}`;

      } catch (err) {
        console.error(err);
        alert("Erro ao verificar sua participa√ß√£o. Tente novamente.");
      }
    });

    // ====== RANKING ======
    function renderData(data){
      rows.innerHTML="";
      const top = data.slice(0,10);
      if(!top.length){
        rows.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px;">Sem resultados ainda.</td></tr>`;
        return;
      }
      let pos=1;
      for(const d of top){
        let medal=pos; 
        if(pos===1) medal="üèÜ"; 
        else if(pos===2) medal="ü•à"; 
        else if(pos===3) medal="ü•â";
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${medal}</td>
          <td>${(d.name||"-").toString().slice(0,48)}</td>
          <td><strong>${d.score ?? 0}</strong></td>
          <td>${Number.isFinite(d.totalTime)? d.totalTime.toFixed(1)+"s":"-"}</td>`;
        rows.appendChild(tr); pos++;
      }
    }

    async function startLive(){
      try{
        const baseQ = query(collection(db,"scores"), orderBy("score","desc"), limit(10));
        const snap  = await getDocs(baseQ);
        const pre   = snap.docs.map(d=>d.data())
                         .sort((a,b)=> (b.score??0)-(a.score??0) || (a.totalTime??9e9)-(b.totalTime??9e9));
        renderData(pre);

        onSnapshot(baseQ, (s)=>{
          const arr = s.docs.map(d=>d.data())
                       .sort((a,b)=> (b.score??0)-(a.score??0) || (a.totalTime??9e9)-(b.totalTime??9e9));
          renderData(arr);
        });
      }catch(e){ console.error("Erro ao carregar ranking:", e); }
    }
    startLive();
  </script>
  <!-- √çcone de engrenagem transl√∫cido -->
<div id="settingsBtn" 
     style="position: fixed; bottom: 20px; right: 20px; font-size: 24px; color: rgba(255,255,255,0.6);
            cursor: pointer; z-index: 999; transition: all 0.3s ease;">
  ‚öôÔ∏è
</div>

<script>
  const settingsBtn = document.getElementById("settingsBtn");
  settingsBtn.addEventListener("click", () => {
    const senha = prompt("Digite a senha de administrador:");
    if (senha && senha.trim() === "emr2025") {
      window.location.href = "admin.html?auth=ok";
    } else if (senha !== null) {
      alert("Senha incorreta.");
    }
  });
</script>

</body>
</html>
